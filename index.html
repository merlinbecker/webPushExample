<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebPush Beispiel</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .status {
            margin: 20px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #b8daff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>WebPush Benachrichtigungen Beispiel</h1>
        
        <div id="status" class="status info">
            Browser-Unterstützung wird überprüft...
        </div>
        
        <div>
            <button id="enable-push" disabled>Push-Benachrichtigungen aktivieren</button>
            <button id="send-push" disabled>Test-Benachrichtigung senden</button>
        </div>
        
        <div>
            <h3>Über dieses Beispiel:</h3>
            <p>Diese Anwendung demonstriert die Grundlagen von Web Push Benachrichtigungen:</p>
            <ul>
                <li>Registrierung eines Service Workers</li>
                <li>Anfrage von Benachrichtigungsberechtigungen</li>
                <li>Abonnement für Push-Benachrichtigungen</li>
                <li>Senden von Test-Benachrichtigungen</li>
            </ul>
        </div>
    </div>

    <script>
        const statusDiv = document.getElementById('status');
        const enableButton = document.getElementById('enable-push');
        const sendButton = document.getElementById('send-push');

        function updateStatus(message, type = 'info') {
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        // Check for service worker support
        if ('serviceWorker' in navigator && 'PushManager' in window) {
            updateStatus('Service Worker und Push Manager werden unterstützt');
            enableButton.disabled = false;
        } else {
            updateStatus('Service Worker oder Push Manager werden nicht unterstützt', 'error');
        }

        // Register service worker
        async function registerServiceWorker() {
            try {
                const registration = await navigator.serviceWorker.register('/sw.js');
                console.log('Service Worker registriert:', registration);
                return registration;
            } catch (error) {
                console.error('Service Worker Registrierung fehlgeschlagen:', error);
                updateStatus('Service Worker Registrierung fehlgeschlagen', 'error');
                throw error;
            }
        }

        // Request notification permission
        async function requestNotificationPermission() {
            const permission = await Notification.requestPermission();
            if (permission !== 'granted') {
                throw new Error('Benachrichtigungsberechtigung verweigert');
            }
            return permission;
        }

        // Subscribe to push notifications
        async function subscribeToPush() {
            try {
                const registration = await registerServiceWorker();
                await requestNotificationPermission();
                
                const response = await fetch('/vapid-public-key');
                const vapidPublicKey = await response.text();
                
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: vapidPublicKey
                });
                
                // Send subscription to server
                await fetch('/subscribe', {
                    method: 'POST',
                    body: JSON.stringify(subscription),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                updateStatus('Push-Benachrichtigungen erfolgreich aktiviert!', 'success');
                enableButton.disabled = true;
                sendButton.disabled = false;
                
            } catch (error) {
                console.error('Fehler beim Aktivieren der Push-Benachrichtigungen:', error);
                updateStatus(`Fehler: ${error.message}`, 'error');
            }
        }

        // Send test notification
        async function sendTestNotification() {
            try {
                const response = await fetch('/send-notification', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    updateStatus('Test-Benachrichtigung gesendet!', 'success');
                } else {
                    updateStatus('Fehler beim Senden der Benachrichtigung', 'error');
                }
            } catch (error) {
                console.error('Fehler beim Senden der Benachrichtigung:', error);
                updateStatus(`Fehler: ${error.message}`, 'error');
            }
        }

        enableButton.addEventListener('click', subscribeToPush);
        sendButton.addEventListener('click', sendTestNotification);
    </script>
</body>
</html>